{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/canonical-sales-order.json",
  "title": "CanonicalSalesOrder",
  "type": "object",
  "required": [
    "meta",
    "customer",
    "line_items",
    "issues",
    "confidence"
  ],
  "properties": {
    "meta": {
      "type": "object",
      "required": [
        "case_id",
        "tenant_id",
        "received_at",
        "source_filename",
        "file_sha256"
      ],
      "properties": {
        "case_id": {
          "type": "string"
        },
        "tenant_id": {
          "type": "string",
          "description": "Teams tenant ID (channelData.tenant.id)"
        },
        "received_at": {
          "type": "string",
          "format": "date-time"
        },
        "source_filename": {
          "type": "string"
        },
        "file_sha256": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$"
        },
        "uploader": {
          "type": "object",
          "properties": {
            "aad_user_id": {
              "type": "string"
            },
            "teams_user_id": {
              "type": "string"
            },
            "display_name": {
              "type": "string"
            }
          },
          "additionalProperties": true
        },
        "language_hint": {
          "type": [
            "string",
            "null"
          ],
          "description": "e.g. en, fa; detected from headers/values if possible"
        },
        "parsing": {
          "type": "object",
          "properties": {
            "parser_version": {
              "type": "string"
            },
            "contains_formulas": {
              "type": "boolean"
            },
            "sheets_processed": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          },
          "additionalProperties": true
        },
        "correlation": {
          "type": "object",
          "properties": {
            "trace_id": {
              "type": "string"
            },
            "span_id": {
              "type": "string"
            },
            "teams_activity_id": {
              "type": "string"
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "customer": {
      "type": "object",
      "required": [
        "input_name",
        "resolution_status"
      ],
      "properties": {
        "input_name": {
          "type": [
            "string",
            "null"
          ],
          "description": "Raw name found in spreadsheet (if any)"
        },
        "selected_by_user": {
          "type": [
            "string",
            "null"
          ],
          "description": "If user selected customer explicitly"
        },
        "zoho_customer_id": {
          "type": [
            "string",
            "null"
          ]
        },
        "zoho_customer_name": {
          "type": [
            "string",
            "null"
          ]
        },
        "resolution_status": {
          "type": "string",
          "enum": [
            "unresolved",
            "resolved",
            "ambiguous",
            "not_found"
          ]
        },
        "match": {
          "type": "object",
          "properties": {
            "method": {
              "type": [
                "string",
                "null"
              ],
              "enum": [
                "exact",
                "fuzzy",
                "user_selected",
                "none",
                null
              ]
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            },
            "candidates": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "zoho_customer_id": {
                    "type": "string"
                  },
                  "zoho_customer_name": {
                    "type": "string"
                  },
                  "score": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 1
                  }
                },
                "required": [
                  "zoho_customer_id",
                  "zoho_customer_name",
                  "score"
                ],
                "additionalProperties": true
              }
            }
          },
          "additionalProperties": true
        },
        "evidence": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "sheet",
              "cell",
              "raw_value"
            ],
            "properties": {
              "sheet": {
                "type": "string"
              },
              "cell": {
                "type": "string"
              },
              "raw_value": {}
            },
            "additionalProperties": true
          }
        }
      },
      "additionalProperties": true
    },
    "line_items": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": [
          "row",
          "quantity"
        ],
        "properties": {
          "row": {
            "type": "integer",
            "minimum": 0,
            "description": "0-based index into detected line item rows"
          },
          "source_row_number": {
            "type": [
              "integer",
              "null"
            ],
            "description": "Spreadsheet row number (1-based) if known"
          },
          "sku": {
            "type": [
              "string",
              "null"
            ]
          },
          "gtin": {
            "type": [
              "string",
              "null"
            ],
            "pattern": "^\\d{8}|\\d{12,14}$"
          },
          "product_name": {
            "type": [
              "string",
              "null"
            ]
          },
          "quantity": {
            "type": "number",
            "minimum": 0,
            "description": "Qty can be 0+; 0 is valid"
          },
          "unit_price_source": {
            "type": [
              "number",
              "null"
            ]
          },
          "unit_price_zoho": {
            "type": [
              "number",
              "null"
            ],
            "description": "Zoho price takes precedence for payload"
          },
          "line_total_source": {
            "type": [
              "number",
              "null"
            ]
          },
          "currency": {
            "type": [
              "string",
              "null"
            ],
            "description": "ISO 4217 if detected"
          },
          "zoho_item_id": {
            "type": [
              "string",
              "null"
            ]
          },
          "match": {
            "type": "object",
            "properties": {
              "status": {
                "type": "string",
                "enum": [
                  "unresolved",
                  "resolved",
                  "ambiguous",
                  "not_found"
                ]
              },
              "method": {
                "type": [
                  "string",
                  "null"
                ],
                "enum": [
                  "sku",
                  "gtin",
                  "name_fuzzy",
                  "user_selected",
                  "none",
                  null
                ]
              },
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              },
              "candidates": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "zoho_item_id": {
                      "type": "string"
                    },
                    "sku": {
                      "type": [
                        "string",
                        "null"
                      ]
                    },
                    "name": {
                      "type": "string"
                    },
                    "gtin": {
                      "type": [
                        "string",
                        "null"
                      ]
                    },
                    "score": {
                      "type": "number",
                      "minimum": 0,
                      "maximum": 1
                    }
                  },
                  "required": [
                    "zoho_item_id",
                    "name",
                    "score"
                  ],
                  "additionalProperties": true
                }
              }
            },
            "additionalProperties": true
          },
          "evidence": {
            "type": "object",
            "properties": {
              "sku": {
                "$ref": "#/$defs/evidenceCell"
              },
              "gtin": {
                "$ref": "#/$defs/evidenceCell"
              },
              "product_name": {
                "$ref": "#/$defs/evidenceCell"
              },
              "quantity": {
                "$ref": "#/$defs/evidenceCell"
              },
              "unit_price_source": {
                "$ref": "#/$defs/evidenceCell"
              },
              "line_total_source": {
                "$ref": "#/$defs/evidenceCell"
              }
            },
            "additionalProperties": true
          },
          "flags": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "additionalProperties": true
      }
    },
    "totals": {
      "type": "object",
      "properties": {
        "subtotal_source": {
          "type": [
            "number",
            "null"
          ]
        },
        "tax_total_source": {
          "type": [
            "number",
            "null"
          ]
        },
        "total_source": {
          "type": [
            "number",
            "null"
          ]
        },
        "currency": {
          "type": [
            "string",
            "null"
          ]
        },
        "evidence": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/evidenceCell"
          }
        }
      },
      "additionalProperties": true
    },
    "schema_inference": {
      "type": "object",
      "properties": {
        "selected_sheet": {
          "type": "string"
        },
        "table_region": {
          "type": "string",
          "description": "e.g. A1:H42"
        },
        "header_row": {
          "type": [
            "integer",
            "null"
          ],
          "description": "1-based row number of header if known"
        },
        "column_mappings": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "canonical_field",
              "source_header",
              "confidence"
            ],
            "properties": {
              "canonical_field": {
                "type": "string"
              },
              "source_header": {
                "type": "string"
              },
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              },
              "method": {
                "type": "string",
                "enum": [
                  "dictionary",
                  "fuzzy",
                  "embedding",
                  "llm_tiebreak",
                  "manual"
                ]
              },
              "candidates": {
                "type": "array",
                "items": {
                  "type": "object"
                }
              }
            },
            "additionalProperties": true
          }
        }
      },
      "additionalProperties": true
    },
    "confidence": {
      "type": "object",
      "required": [
        "overall"
      ],
      "properties": {
        "overall": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "by_stage": {
          "type": "object",
          "additionalProperties": {
            "type": "number",
            "minimum": 0,
            "maximum": 1
          }
        },
        "committee": {
          "type": "object",
          "properties": {
            "providers_used": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "votes": {
              "type": "array",
              "items": {
                "type": "object"
              }
            },
            "consensus": {
              "type": "string",
              "enum": [
                "unanimous",
                "majority",
                "split",
                "no_consensus"
              ]
            },
            "disagreements": {
              "type": "array",
              "items": {
                "type": "object"
              }
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "issues": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "code",
          "severity",
          "message"
        ],
        "properties": {
          "code": {
            "type": "string"
          },
          "severity": {
            "type": "string",
            "enum": [
              "info",
              "warning",
              "error",
              "blocker"
            ]
          },
          "message": {
            "type": "string"
          },
          "fields": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "evidence": {
            "type": "array",
            "items": {
              "$ref": "#/$defs/evidenceCell"
            }
          },
          "suggested_user_action": {
            "type": [
              "string",
              "null"
            ]
          }
        },
        "additionalProperties": true
      }
    },
    "approvals": {
      "type": "object",
      "properties": {
        "approved": {
          "type": "boolean"
        },
        "approved_at": {
          "type": [
            "string",
            "null"
          ],
          "format": "date-time"
        },
        "approved_by": {
          "type": [
            "string",
            "null"
          ],
          "description": "AAD user id"
        },
        "approval_method": {
          "type": [
            "string",
            "null"
          ],
          "enum": [
            "adaptive_card",
            "tab",
            "command",
            null
          ]
        }
      },
      "additionalProperties": true
    },
    "zoho": {
      "type": "object",
      "properties": {
        "organisation_id": {
          "type": [
            "string",
            "null"
          ]
        },
        "salesorder_id": {
          "type": [
            "string",
            "null"
          ]
        },
        "salesorder_number": {
          "type": [
            "string",
            "null"
          ]
        },
        "status": {
          "type": [
            "string",
            "null"
          ]
        },
        "request_payload": {
          "type": [
            "object",
            "null"
          ]
        },
        "response_payload": {
          "type": [
            "object",
            "null"
          ]
        }
      },
      "additionalProperties": true
    }
  },
  "$defs": {
    "evidenceCell": {
      "type": "object",
      "required": [
        "sheet",
        "cell"
      ],
      "properties": {
        "sheet": {
          "type": "string"
        },
        "cell": {
          "type": "string"
        },
        "raw_value": {},
        "display_value": {
          "type": [
            "string",
            "null"
          ]
        },
        "number_format": {
          "type": [
            "string",
            "null"
          ]
        }
      },
      "additionalProperties": true
    }
  },
  "additionalProperties": true
}